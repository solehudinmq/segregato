# create a folder
sudo mkdir /var/lib/postgresql/16/master
sudo mkdir /var/lib/postgresql/16/standby1
sudo mkdir /var/lib/postgresql/16/standby2

# change user folder privileges to postgres
sudo chown -R postgres:postgres /var/lib/postgresql/16/master
sudo chown -R postgres:postgres /var/lib/postgresql/16/standby1
sudo chown -R postgres:postgres /var/lib/postgresql/16/standby2

# master data initialization (port 5432)
sudo -u postgres /usr/lib/postgresql/16/bin/initdb -D /var/lib/postgresql/16/master

# check standby1 & standbyN folders must belong to the postgres user
ls -ld /var/lib/postgresql/16/standby1
ls -ld /var/lib/postgresql/16/standby2

# master database configuration
sudo nano /var/lib/postgresql/16/master/postgresql.conf

# start content
listen_addresses = '*'
port = 5432
wal_level = replica
max_wal_senders = 4
max_replication_slots = 2
hot_standby = on
# end content

# postgreSQL client authentication configuration file
sudo -u postgres nano /var/lib/postgresql/16/master/pg_hba.conf

# start content
host    replication     replication_user       127.0.0.1/32            scram-sha-256
# end content

# stop postgresql default (if any)
sudo systemctl stop postgresql

# start database master
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl start -D /var/lib/postgresql/16/master -l /var/lib/postgresql/16/master/master.log

# check if the master database is running
sudo ss -nlt | grep 5432

# replica database initialization (port 5433 & 5434)
# stop & delete replica 1
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl stop -D /var/lib/postgresql/16/standby1
sudo -u postgres rm -rf /var/lib/postgresql/16/standby1/*
# stop & delete replica N
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl stop -D /var/lib/postgresql/16/standby2
sudo -u postgres rm -rf /var/lib/postgresql/16/standby2/*

# login to psql cli
sudo -u postgres psql

CREATE USER replication_user WITH REPLICATION LOGIN ENCRYPTED PASSWORD 'replication_user';

SELECT * FROM pg_create_physical_replication_slot('standby1_slot');
SELECT * FROM pg_create_physical_replication_slot('standby2_slot');
SELECT slot_name, slot_type, active FROM pg_replication_slots;
# logout from psql cli

# creating a Base Backup (initial data copy) from the primary PostgreSQL server and preparing the current server to become a Standby server (Replica), using the Streaming Replication and Replication Slot methods.
sudo -u postgres pg_basebackup -h 127.0.0.1 -p 5432 -U replication_user -D /var/lib/postgresql/16/standby1 -F p -X stream -R -W -v --slot=standby1_slot
sudo -u postgres pg_basebackup -h 127.0.0.1 -p 5432 -U replication_user -D /var/lib/postgresql/16/standby2 -F p -X stream -R -W -v --slot=standby2_slot

# replica1 database configuration
sudo -u postgres nano /var/lib/postgresql/16/standby1/postgresql.conf

# start content
port = 5433
# end content

# replicaN database configuration
sudo -u postgres nano /var/lib/postgresql/16/standby2/postgresql.conf

# start content
port = 5434
# end content

# update replica permissions
sudo chmod 0700 /var/lib/postgresql/16/standby1
sudo chmod 0700 /var/lib/postgresql/16/standby2

# start database replica
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl start -D /var/lib/postgresql/16/standby1 -l /var/lib/postgresql/16/standby1/standby1.log
sudo -u postgres /usr/lib/postgresql/16/bin/pg_ctl start -D /var/lib/postgresql/16/standby2 -l /var/lib/postgresql/16/standby2/standby2.log

# check if the replica database is running
sudo ss -nlt | grep 5433
sudo ss -nlt | grep 5434

# login to psql cli
sudo -u postgres psql

SELECT client_addr, state, sync_state, application_name
FROM pg_stat_replication;

CREATE DATABASE coba_cqrs;

\c coba_cqrs;

CREATE TABLE posts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title VARCHAR(255) NOT NULL,
    content TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

# logout from psql cli